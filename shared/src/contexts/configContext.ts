import * as AbcEmergencyTripPermit from "../../../content/src/fieldConfig/abc-emergency-trip-permit.json";
import * as AccountSetup from "../../../content/src/fieldConfig/account-setup-page.json";
import * as anytimeActionReinstatementAndLicenseCalendarEventStatusDefaults from "../../../content/src/fieldConfig/anytime-action-reinstatement-and-license-calendar-event-status-defaults.json";
import * as AutosaveDefaults from "../../../content/src/fieldConfig/autosave-defaults.json";
import * as BetaBar from "../../../content/src/fieldConfig/beta-bar.json";
import * as BusinessFormation from "../../../content/src/fieldConfig/business-formation.json";
import * as BusinessStructurePrompt from "../../../content/src/fieldConfig/business-structure-prompt.json";
import * as BusinessStructureTask from "../../../content/src/fieldConfig/business-structure-task.json";
import * as CalloutDefaults from "../../../content/src/fieldConfig/callout-defaults.json";
import * as CannabisLicenseAnnualTab2 from "../../../content/src/fieldConfig/cannabis-license-annual-tab2.json";
import * as CannabisLicenseConditionalTab2 from "../../../content/src/fieldConfig/cannabis-license-conditional-tab2.json";
import * as CannabisLicenseEligibilityModal from "../../../content/src/fieldConfig/cannabis-license-eligibility-modal.json";
import * as CannabisLicenseTab1 from "../../../content/src/fieldConfig/cannabis-license-tab1.json";
import * as CannabisPriorityStatusTab1 from "../../../content/src/fieldConfig/cannabis-priority-status-tab1.json";
import * as CannabisPriorityStatusTab2 from "../../../content/src/fieldConfig/cannabis-priority-status-tab2.json";
import * as CheckAccountEmailPage from "../../../content/src/fieldConfig/check-account-email-page.json";
import * as CigaretteLicenseConfirmation from "../../../content/src/fieldConfig/cigarette-license-confirmation.json";
import * as CigaretteLicenseShared from "../../../content/src/fieldConfig/cigarette-license-shared.json";
import * as CigaretteLicenseStep1 from "../../../content/src/fieldConfig/cigarette-license-step1.json";
import * as CigaretteLicenseStep2 from "../../../content/src/fieldConfig/cigarette-license-step2.json";
import * as CigaretteLicenseStep3 from "../../../content/src/fieldConfig/cigarette-license-step3.json";
import * as CigaretteLicenseStep4 from "../../../content/src/fieldConfig/cigarette-license-step4.json";
import * as CrtkTask from "../../../content/src/fieldConfig/crtk.json";
import * as DashboardCalendar from "../../../content/src/fieldConfig/dashboard-calendar.json";
import * as DashboardDefaults from "../../../content/src/fieldConfig/dashboard-defaults.json";
import * as DashboardModals from "../../../content/src/fieldConfig/dashboard-modals.json";
import * as DashboardSnackbars from "../../../content/src/fieldConfig/dashboard-snackbars.json";
import * as DashboardTabs from "../../../content/src/fieldConfig/dashboard-tabs.json";
import * as DeferredLocation from "../../../content/src/fieldConfig/deferred-location.json";
import * as Ein from "../../../content/src/fieldConfig/ein.json";
import * as ElevatorRegistration from "../../../content/src/fieldConfig/elevator-registration.json";
import * as EmployerRates from "../../../content/src/fieldConfig/employer-rates.json";
import * as EnvironmentQuestionnaire from "../../../content/src/fieldConfig/env-questionnaire.json";
import * as FilingDefaults from "../../../content/src/fieldConfig/filing-defaults.json";
import * as Footer from "../../../content/src/fieldConfig/footer.json";
import * as FormationDataDeletionModal from "../../../content/src/fieldConfig/formation-date-deletion-modal.json";
import * as FormationDateModal from "../../../content/src/fieldConfig/formation-date-modal.json";
import * as FormationInterimSuccessPage from "../../../content/src/fieldConfig/formation-interim-success-page.json";
import * as FormationSuccessPage from "../../../content/src/fieldConfig/formation-success-page.json";
import * as FundingDefaults from "../../../content/src/fieldConfig/funding-defaults.json";
import * as SiteWideErrorMessages from "../../../content/src/fieldConfig/global-errors-defaults.json";
import * as GovernmentContracting from "../../../content/src/fieldConfig/government-contracting.json";
import * as HeaderDefaults from "../../../content/src/fieldConfig/header-defaults.json";
import * as HousingRegistrationSearchTask from "../../../content/src/fieldConfig/housing-registration.json";
import * as LandingPageExperienceB from "../../../content/src/fieldConfig/landing-page-experience-b.json";
import * as LandingPage from "../../../content/src/fieldConfig/landing-page.json";
import * as LegalMessageDefaults from "../../../content/src/fieldConfig/legal-message-defaults.json";
import * as LicenseSearchTask from "../../../content/src/fieldConfig/license-search-task.json";
import * as LoginSupportPage from "../../../content/src/fieldConfig/login-support-page.json";
import * as ManageBusinessVehicles from "../../../content/src/fieldConfig/manage-business-vehicles.json";
import * as NaicsCode from "../../../content/src/fieldConfig/naics-code.json";
import * as NavigationDefaults from "../../../content/src/fieldConfig/navigation-defaults.json";
import * as NexusDbaFormation from "../../../content/src/fieldConfig/nexus-dba-formation.json";
import * as NexusNameSearch from "../../../content/src/fieldConfig/nexus-name-search.json";
import * as FundingsOnboarding from "../../../content/src/fieldConfig/njeda-fundings-onboarding.json";
import * as OnboardingDefaults from "../../../content/src/fieldConfig/onboarding-defaults.json";
import * as PageNotFoundError from "../../../content/src/fieldConfig/page-not-found-error.json";
import * as PassengerTransportCdl from "../../../content/src/fieldConfig/passenger-transport-cdl-tab1.json";
import * as PassengerTransportCdl2 from "../../../content/src/fieldConfig/passenger-transport-cdl-tab2.json";
import * as Profile from "../../../content/src/fieldConfig/profile.json";
import * as RegisteredForTaxesModal from "../../../content/src/fieldConfig/registered-for-taxes-modal.json";
import * as RemoveBusinessModal from "../../../content/src/fieldConfig/remove-business-modal.json";
import * as SearchBusinessNameTask from "../../../content/src/fieldConfig/search-business-name-task.json";
import * as SectionHeaders from "../../../content/src/fieldConfig/section-headers.json";
import * as SelfRegistration from "../../../content/src/fieldConfig/self-registration.json";
import * as SkipToMainContent from "../../../content/src/fieldConfig/skip-to-main-content.json";
import * as StarterKits from "../../../content/src/fieldConfig/starter-kits.json";
import * as TaskDefaults from "../../../content/src/fieldConfig/task-defaults.json";
import * as TaskProgressCard from "../../../content/src/fieldConfig/task-progress-card.json";
import * as TaskProgress from "../../../content/src/fieldConfig/task-progress.json";
import * as TaxAccess from "../../../content/src/fieldConfig/tax-access.json";
import * as TaxCalendar from "../../../content/src/fieldConfig/tax-calendar.json";
import * as TaxClearanceCertificateDownload from "../../../content/src/fieldConfig/tax-clearance-certificate-download.json";
import * as TaxClearanceCertificateShared from "../../../content/src/fieldConfig/tax-clearance-certificate-shared.json";
import * as TaxClearanceCertificateStep1 from "../../../content/src/fieldConfig/tax-clearance-certificate-step1.json";
import * as TaxClearanceCertificateStep2 from "../../../content/src/fieldConfig/tax-clearance-certificate-step2.json";
import * as TaxClearanceCertificateStep3 from "../../../content/src/fieldConfig/tax-clearance-certificate-step3.json";
import * as TaxId from "../../../content/src/fieldConfig/tax-id.json";
import * as UnsupportedNavigatorUserPage from "../../../content/src/fieldConfig/unsupported-navigator-user-page.json";
import * as XrayRegistration from "../../../content/src/fieldConfig/xray-registration.json";
import * as XrayRenewal from "../../../content/src/fieldConfig/xray-renewal.json";
import * as CalloutAlerts from "../../../content/src/mappings/callout-alerts.json";
import * as FundingAgency from "../../../content/src/mappings/fundingAgency.json";
import * as OwnershipTypes from "../../../content/src/mappings/ownershipTypes.json";
import * as Sectors from "../../../content/src/mappings/sectors.json";
import * as TaskAgency from "../../../content/src/mappings/taskAgency.json";
import * as TaxClearanceCertificateIssuingAgencies from "../../../content/src/mappings/taxClearanceCertificateIssuingAgencies.json";
import * as PageMetadata from "../../../content/src/page-metadata/page-metadata.json";

import { merge } from "lodash";
import { createContext } from "react";
import { getDefaultConfig } from "./defaultConfig";

// Filter out undefined/null/empty imports at module load time to prevent them from overriding defaults
const hasContent = (config: unknown): boolean => {
  if (!config || typeof config !== "object") return false;
  return Object.keys(config as Record<string, unknown>).length > 0;
};

// Helper to unwrap JSON imports - handles both direct imports and default-wrapped imports
const unwrapConfig = (config: unknown): unknown => {
  if (!config) return config;
  // If the import has a 'default' property and only that property, unwrap it
  const keys = Object.keys(config as Record<string, unknown>);
  if (keys.length === 1 && keys[0] === "default") {
    return (config as Record<string, unknown>).default;
  }
  return config;
};

export type ConfigType = typeof AbcEmergencyTripPermit &
  typeof AccountSetup &
  typeof anytimeActionReinstatementAndLicenseCalendarEventStatusDefaults &
  typeof AutosaveDefaults &
  typeof BetaBar &
  typeof BusinessFormation &
  typeof BusinessStructurePrompt &
  typeof BusinessStructureTask &
  typeof CalloutAlerts &
  typeof CalloutDefaults &
  typeof CannabisLicenseAnnualTab2 &
  typeof CannabisLicenseConditionalTab2 &
  typeof CannabisLicenseEligibilityModal &
  typeof CannabisLicenseTab1 &
  typeof CannabisPriorityStatusTab1 &
  typeof CannabisPriorityStatusTab2 &
  typeof CheckAccountEmailPage &
  typeof CigaretteLicenseConfirmation &
  typeof CigaretteLicenseShared &
  typeof CigaretteLicenseStep1 &
  typeof CigaretteLicenseStep2 &
  typeof CigaretteLicenseStep3 &
  typeof CigaretteLicenseStep4 &
  typeof CrtkTask &
  typeof DashboardCalendar &
  typeof DashboardDefaults &
  typeof DashboardModals &
  typeof DashboardSnackbars &
  typeof DashboardTabs &
  typeof DeferredLocation &
  typeof Ein &
  typeof ElevatorRegistration &
  typeof EmployerRates &
  typeof EnvironmentQuestionnaire &
  typeof FilingDefaults &
  typeof Footer &
  typeof FormationDataDeletionModal &
  typeof FormationDateModal &
  typeof FormationInterimSuccessPage &
  typeof FormationSuccessPage &
  typeof FundingAgency &
  typeof FundingDefaults &
  typeof FundingsOnboarding &
  typeof GovernmentContracting &
  typeof HeaderDefaults &
  typeof HousingRegistrationSearchTask &
  typeof LandingPage &
  typeof LandingPageExperienceB &
  typeof LegalMessageDefaults &
  typeof LicenseSearchTask &
  typeof LoginSupportPage &
  typeof ManageBusinessVehicles &
  typeof NaicsCode &
  typeof NavigationDefaults &
  typeof NexusDbaFormation &
  typeof NexusNameSearch &
  typeof OnboardingDefaults &
  typeof OwnershipTypes &
  typeof PageMetadata &
  typeof PageNotFoundError &
  typeof PassengerTransportCdl &
  typeof PassengerTransportCdl2 &
  typeof Profile &
  typeof RegisteredForTaxesModal &
  typeof RemoveBusinessModal &
  typeof SearchBusinessNameTask &
  typeof Sectors &
  typeof SectionHeaders &
  typeof SelfRegistration &
  typeof SiteWideErrorMessages &
  typeof SkipToMainContent &
  typeof StarterKits &
  typeof TaskAgency &
  typeof TaskDefaults &
  typeof TaskProgress &
  typeof TaskProgressCard &
  typeof TaxAccess &
  typeof TaxCalendar &
  typeof TaxClearanceCertificateDownload &
  typeof TaxClearanceCertificateIssuingAgencies &
  typeof TaxClearanceCertificateShared &
  typeof TaxClearanceCertificateStep1 &
  typeof TaxClearanceCertificateStep2 &
  typeof TaxClearanceCertificateStep3 &
  typeof TaxId &
  typeof UnsupportedNavigatorUserPage &
  typeof XrayRegistration &
  typeof XrayRenewal;

export const getMergedConfig = (): ConfigType => {
  // Filter out undefined/null/empty imports to prevent them from overriding defaults
  const configs = [
    AbcEmergencyTripPermit,
    AccountSetup,
    anytimeActionReinstatementAndLicenseCalendarEventStatusDefaults,
    AutosaveDefaults,
    BetaBar,
    BusinessFormation,
    BusinessStructurePrompt,
    BusinessStructureTask,
    CalloutAlerts,
    CalloutDefaults,
    CannabisLicenseAnnualTab2,
    CannabisLicenseConditionalTab2,
    CannabisLicenseEligibilityModal,
    CannabisLicenseTab1,
    CannabisPriorityStatusTab1,
    CannabisPriorityStatusTab2,
    CheckAccountEmailPage,
    CigaretteLicenseConfirmation,
    CigaretteLicenseShared,
    CigaretteLicenseStep1,
    CigaretteLicenseStep2,
    CigaretteLicenseStep3,
    CigaretteLicenseStep4,
    CrtkTask,
    DashboardCalendar,
    DashboardDefaults,
    DashboardModals,
    DashboardSnackbars,
    DashboardTabs,
    DeferredLocation,
    Ein,
    ElevatorRegistration,
    EmployerRates,
    EnvironmentQuestionnaire,
    FilingDefaults,
    Footer,
    FormationDataDeletionModal,
    FormationDateModal,
    FormationInterimSuccessPage,
    FormationSuccessPage,
    FundingAgency,
    FundingDefaults,
    FundingsOnboarding,
    GovernmentContracting,
    HeaderDefaults,
    HousingRegistrationSearchTask,
    LandingPage,
    LandingPageExperienceB,
    LegalMessageDefaults,
    LicenseSearchTask,
    LoginSupportPage,
    ManageBusinessVehicles,
    NaicsCode,
    NavigationDefaults,
    NexusDbaFormation,
    NexusNameSearch,
    OnboardingDefaults,
    OwnershipTypes,
    PageMetadata,
    PageNotFoundError,
    PassengerTransportCdl,
    PassengerTransportCdl2,
    Profile,
    RegisteredForTaxesModal,
    RemoveBusinessModal,
    SearchBusinessNameTask,
    Sectors,
    SectionHeaders,
    SelfRegistration,
    SiteWideErrorMessages,
    SkipToMainContent,
    StarterKits,
    TaskAgency,
    TaskDefaults,
    TaskProgress,
    TaskProgressCard,
    TaxAccess,
    TaxCalendar,
    TaxClearanceCertificateDownload,
    TaxClearanceCertificateIssuingAgencies,
    TaxClearanceCertificateShared,
    TaxClearanceCertificateStep1,
    TaxClearanceCertificateStep2,
    TaxClearanceCertificateStep3,
    TaxId,
    UnsupportedNavigatorUserPage,
    XrayRegistration,
    XrayRenewal,
  ]
    .map((config) => unwrapConfig(config))
    .filter((config) => hasContent(config));

  const defaultConfig = getDefaultConfig();

  // If no valid configs to merge, just return defaults
  if (configs.length === 0) {
    return defaultConfig as unknown as ConfigType;
  }

  // Start with a fresh copy of defaults, then merge configs on top
  const mergedConfig = merge({}, defaultConfig, ...configs);

  // Ensure all critical top-level properties exist by falling back to defaults
  // This handles cases where JSON imports fail during SSG
  const criticalProperties = [
    "profileDefaults",
    "pagesMetadata",
    "navigationDefaults",
    "filingDefaults",
    "taskDefaults",
    "calloutDefaults",
    "selfRegistration",
    "accountSetup",
    "siteWideErrorMessages",
  ] as const;

  for (const property of criticalProperties) {
    if (!mergedConfig[property] || typeof mergedConfig[property] !== "object") {
      mergedConfig[property] = defaultConfig[property];
    }
  }

  // Final safety check - if still invalid, return defaults
  if (!mergedConfig || !mergedConfig.pagesMetadata) {
    return defaultConfig as unknown as ConfigType;
  }

  return mergedConfig;
};

export interface ConfigContextType {
  config: ConfigType;
  setOverrides: (config: ConfigType) => void;
}

export const ConfigContext = createContext<ConfigContextType>({
  config: getDefaultConfig() as unknown as ConfigType,
  setOverrides: () => {},
});

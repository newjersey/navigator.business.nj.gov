services:
  dynamodb-local:
    image: amazon/dynamodb-local:latest
    container_name: dynamodb-local
    command: "-jar DynamoDBLocal.jar -sharedDb -dbPath ./data"
    working_dir: /home/dynamodblocal
    volumes:
      - db_data:/home/dynamodblocal/data
    ports:
      - "8000:8000"
    user: root

  dynamodb-init:
    image: amazon/aws-cli
    depends_on:
      - dynamodb-local
    volumes:
      - ~/.aws/credentials:/root/.aws/credentials:ro
      - ./api/users-dynamodb-schema.json:/users-dynamodb-schema.json:ro
      - ./api/businesses-dynamodb-schema.json:/businesses-dynamodb-schema.json:ro
    entrypoint: ""
    command: |
      bash -c "
        echo 'Waiting for DynamoDB Local to be ready...';
        until curl -s http://dynamodb-local:8000 > /dev/null; do
          echo 'DynamoDB Local not yet ready, retrying in 3s...';
          sleep 3;
        done;
        echo 'DynamoDB Local is ready!';

        echo 'Creating users-table-local...';
        aws dynamodb create-table --cli-input-json file:///users-dynamodb-schema.json --endpoint-url http://dynamodb-local:8000 --region us-east-1;

        echo 'Creating businesses-table-local...';
        aws dynamodb create-table --cli-input-json file:///businesses-dynamodb-schema.json --endpoint-url http://dynamodb-local:8000 --region us-east-1;

        echo 'Tables created successfully:';
        aws dynamodb list-tables --endpoint-url http://dynamodb-local:8000 --region us-east-1;
      "

  dynamodb-admin:
    image: aaronshaf/dynamodb-admin
    depends_on:
      - dynamodb-local
    environment:
      - DYNAMO_ENDPOINT=http://dynamodb-local:8000
    ports:
      - "8001:8001"

  # wiremock:
  #   build:
  #     context: .
  #     dockerfile: ./api/local.dev.wiremock.Dockerfile
  #   platform: linux/amd64
  #   volumes:
  #     - .:/workspace
  #     - wiremock_modules:/root/.jdeploy
  #   working_dir: /workspace/api
  #   ports:
  #     - "9000:9000"

  # api:
  #   build:
  #     context: .
  #     dockerfile: ./api/local.dev.api.Dockerfile
  #   depends_on:
  #     dynamodb-init:
  #       condition: service_completed_successfully
  #   volumes:
  #     - ./api/src:/workspace/api/src
  #     - ./api/scripts:/workspace/api/scripts
  #     - ~/.aws/credentials:/root/.aws/credentials:ro
  #   working_dir: /workspace/api
  #   ports:
  #     - "5002:5002"
  #   env_file:
  #     - ./api/.env
  #   environment:
  #     - AWS_ACCESS_KEY_ID=local
  #     - AWS_REGION=us-east-1
  #     - AWS_SECRET_ACCESS_KEY=local
  #     - IS_DOCKER=true
  #     - DYNAMODB_ENDPOINT=http://dynamodb-local:8000
  #     - USE_WIREMOCK_FOR_FORMATION_AND_BUSINESS_SEARCH=true
  #     - TAX_CLEARANCE_CERTIFICATE_URL=http://wiremock:9000
  #     - BUSINESS_NAME_BASE_URL=http://wiremock:9000
  #     - FORMATION_API_BASE_URL=http://wiremock:9000
  #     - DYNAMODB_PORT=8000

  # web:
  #   build:
  #     context: .
  #     dockerfile: ./web/local.dev.web.Dockerfile
  #   depends_on:
  #     - api
  #   tty: true
  #   volumes:
  #     - ./web:/workspace/web
  #     - ./content:/workspace/content
  #   working_dir: /workspace/web
  #   ports:
  #     - "3000:3000"
  #   environment:
  #     - NODE_ENV=development
      # - npm_config_platform=linux
      # - npm_config_arch=x64
      # - npm_config_build_from_source=true

volumes:
  db_data: {}
  wiremock_modules: {}
